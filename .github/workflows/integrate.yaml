# https://docs.github.com/en/actions

name: "Integrate"

on:
  pull_request: null
  push:
    branches:
      - "master"

jobs:
  build:
    name: "Build"
    runs-on: "ubuntu-latest"
    continue-on-error: true

    strategy:
      matrix:
        language:
          - "de"
          - "en"
          - "es"
          - "fr"
          - "it"
          - "ja"
          - "pl"
          - "pt_br"
#          - "ro"
          - "ru"
          - "tr"
          - "uk"
          - "zh"

    steps:
      - name: "Checkout doc-base"
        uses: "actions/checkout@v4"
        with:
          path: "doc-base"
          fetch-depth: 0

      - name: "Checkout doc-${{ matrix.language }}"
        uses: "actions/checkout@v4"
        with:
          path: "${{ matrix.language }}"
          repository: "php/doc-${{ matrix.language }}"

      - name: "Checkout doc-en (fallback)"
        if: "matrix.language != 'en'"
        uses: "actions/checkout@v4"
        with:
          path: "en"
          repository: "php/doc-en"

      - name: "Ensure doc-base is correctly merged into master (debug)"
        run: |
          echo === This step will fail if the merge commit is not targeting master
          cd doc-base
          echo === git log -n 3
          git log -n 3
          echo === git show HEAD
          git show HEAD
          echo === git merge --no-ff --no-commit master
          git merge --no-ff --no-commit origin/master

      - name: "Run QA scripts for EN docs"
        if: "matrix.language == 'en'"
        run: |
          php doc-base/scripts/qa/extensions.xml.php --check
          php doc-base/scripts/qa/section-order.php

      - name: "Build documentation for ${{ matrix.language }}"
        run: "php doc-base/configure.php --disable-libxml-check --enable-xml-details --redirect-stderr-to-stdout --with-lang=${{ matrix.language }}"
